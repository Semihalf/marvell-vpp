From df0ced3b0336964bb49f25dc95b1b4b192281286 Mon Sep 17 00:00:00 2001
From: Zyta Szpak <zr@semihalf.com>
Date: Wed, 7 Mar 2018 22:32:38 +0100
Subject: [PATCH 42/74] mrvlna: add link_down callback

---
 drivers/net/mrvlna/mrvlna_ethdev.c | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/drivers/net/mrvlna/mrvlna_ethdev.c b/drivers/net/mrvlna/mrvlna_ethdev.c
index 54aacf0..02a5c22 100644
--- a/drivers/net/mrvlna/mrvlna_ethdev.c
+++ b/drivers/net/mrvlna/mrvlna_ethdev.c
@@ -747,6 +747,26 @@ mrvlna_dev_set_link_up(struct rte_eth_dev *dev)
 }
 
 /**
+ * DPDK callback to bring the link down.
+ *
+ * @param dev
+ *   Pointer to Ethernet device structure.
+ *
+ * @return
+ *   0 on success, negative error value otherwise.
+ */
+static int
+mrvlna_dev_set_link_down(struct rte_eth_dev *dev)
+{
+	struct neta_priv *priv = dev->data->dev_private;
+
+	if (!priv->ppio)
+		return -EPERM;
+
+	return neta_ppio_disable(priv->ppio);
+}
+
+/**
  * DPDK callback to configure the receive queue.
  *
  * @param dev
@@ -973,6 +993,7 @@ mrvlna_dev_stop(struct rte_eth_dev *dev)
 	struct neta_priv *priv = dev->data->dev_private;
 	int i;
 
+	mrvlna_dev_set_link_down(dev);
 	RTE_LOG(INFO, PMD, "Flushing rx queues\n");
 	for (i = 0; i < dev->data->nb_rx_queues; i++) {
 		struct neta_rxq *rxq = dev->data->rx_queues[i];
@@ -1080,7 +1101,7 @@ static const struct eth_dev_ops mrvlna_ops = {
 	.dev_start = mrvlna_dev_start,
 	.dev_stop = mrvlna_dev_stop,
 	.dev_set_link_up = mrvlna_dev_set_link_up,
-//	.dev_set_link_down = ,
+	.dev_set_link_down = mrvlna_dev_set_link_down,
 //	.dev_close = ,
 	.link_update = mrvlna_link_update,
 //	.mac_addr_remove = ,
-- 
2.7.4

